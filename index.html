<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <title>Socket.io Chat App</title>
</head>

<body>

    <div id="app">
        <div class="container">
            <div class="col-lg-6 offset-lg-3">  

                <div v-if="ready">
                    <p v-for="item in info">
                    {{ item.name }} {{ item.type }}
                    </p>
                </div>

                <div v-if="ready">
                    <h4>Your Nickname</h4>
                </div>
                    <form @submit.prevent="addName">
                        <div class="form-group row">
                          <input type="text" class="form-control" v-model="name" placeholder="What's your nickname?">
                          <input type="submit" value="Add" class="btn btn-sm btn-info ml-1">
                        </div>
                        
                      </form>
                </div>

                <h2 v-else="ready">{{ name }}</h2>
                <div class="card bg-info" v-if="ready">
                    <div class="card-header">
                      My Chat App <span class="float-right">{{connections}} connections</span>
                    </div>
                    <ul class="list-group list-group-flush text-right">
                        <small v-if="typing">{{typing}} is typing...</small>
                        <li class="list-group-item" v-for="message in messages"> {{ message }}
                          <span :class="{'float-left':message.type === 1}"> {{ message.message }}
                            <small>{{ message.by }}</small>
                          </span>                       
                         </li>
                    </ul>

                    <div class="card-body">
                        <form @submit.prevent="send">
                            <div class="form-group">
                              <input type="text" class="form-control" v-model="newmessage" placeholder="Type Here">
                            </div>
                            
                          </form>

                    </div>
                  </div>

            </div>

        </div>
    </div>



    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.js" integrity="sha256-NSuqgY2hCZJUN6hDMFfdxvkexI7+iLxXQbL540RQ/c4=" crossorigin="anonymous"></script>
    <script>
  var socket = io();
  let app = new Vue({
      el: '#app', // bind with app element
      data: {
        newmessage: null,
        messages: [],
        typing: false,
        name: null,
        ready: false,
        info: [],
        connections: 0
      },

      watch: {
        newmessage(value){
            value ? socket.emit('typing', this.name) : socket.emit('stopTyping')
        }
      },

      methods: {
        send() {
            this.messages.push({ message: this.newmessage, type: 0, by: 'Me' })
            socket.emit('chat-message', {message:this.newmessage, user:this.name})
            this.newmessage = null // clear out new mssg
          }
      },
      addName(){
        this.ready = true
        socket.emit('joined', this.name)
      },

      created() {
          window.onbeforeunload = () => {
              socket.emit('left', this.name)
          }

          socket.on('connections',(data) => {
              this.connections = data
          })

          socket.emit('Created', 'Alissar')
          socket.on('Created',(data) => {
             console.log(data) 
          })

          socket.on('chat-message',(data) => { // user receiving mssg
              this.messages.push({ message: data.message, type: 1, by:data.user })
          })

          socket.on('typing', () => {
              this.typing = name
          })

          socket.on('stopTyping', () => {
              this.typing = false
          })


          socket.on('joined', (data) => {
              this.info.push({ name:data,type:'Joined' })
              setTimeout(() => {
                  this.info = []
              }, 5000);
          })

          socket.on('left', (data) => {
              this.info.push({ name:data,type:'Left' })
              setTimeout(() => {
                  this.info = []
              }, 5000);
          })
      }
  })

</script>
</body>
</html>